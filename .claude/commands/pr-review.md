# PR レビューコマンド

このコマンドは、GitHub Pull Request の変更内容を分析し、コードレビューを実施します。

## 使い方
```
/pr-review <pr_number>
```

## 処理フロー

1. **PR の取得**: `gh pr view` コマンドで PR の詳細を取得
2. **変更内容の取得**: `gh pr diff` で変更されたコードを取得
3. **コードレビューの実施**: プロジェクトの規約に基づいて分析
4. **レビュー結果の表示**: 見つかった問題点や改善提案を報告
5. **メモリへの保存**: レビュー結果を `pr-review-<番号>` として保存

## 実行手順

### ステップ1: PR 情報の取得

```bash
gh pr view {{args}} --json number,title,body,state,author,labels,files,additions,deletions,commits
```

もし `gh` コマンドが利用できない場合は、ユーザーに GitHub CLI のインストールを促してください。

### ステップ2: 変更内容の取得

```bash
gh pr diff {{args}}
```

変更内容が大きすぎる場合（例: 1000行以上）は、ファイルごとに分割して確認することを検討してください。

### ステップ3: コードレビューの実施

以下の観点で PR をレビューしてください：

#### 3-1. プロジェクト規約のチェック

**Backend（Rails API）の場合：**
- ✅ ルーティングは `/api/v1` 配下で `config/routes/api_v1.rb` に定義されているか
- ✅ コントローラは `app/controllers/api/v1/` に配置されているか
- ✅ データベース変更は `db/Schemafile` で定義されているか（migrationファイルではない）
- ✅ API ドキュメント（Rswag）が更新されているか
- ✅ RSpec テストが含まれているか
- ✅ FactoryBot の定義が適切か
- ✅ Devise/JWT 認証が適切に実装されているか（必要な場合）

**Frontend（Next.js）の場合：**
- ✅ ファイルは `type_labo/` ディレクトリに配置されているか
- ✅ TypeScript の型定義が適切か
- ✅ React Native Web のコンポーネントを使用しているか
- ✅ Zod でのバリデーションが適切か（必要な場合）
- ✅ Tailwind CSS v4 を使用しているか

#### 3-2. コード品質のチェック

- **可読性**: コードは理解しやすいか、適切な変数名・関数名が使われているか
- **重複**: DRY原則に従っているか、コードの重複はないか
- **複雑度**: 過度に複雑なロジックはないか、リファクタリングの余地はないか
- **命名規則**: Rails/TypeScript の命名規則に従っているか

#### 3-3. バグ・セキュリティのチェック

- **Nil/Null チェック**: 適切なエラーハンドリングがあるか
- **SQL インジェクション**: パラメータ化されたクエリを使用しているか
- **XSS 対策**: ユーザー入力を適切にエスケープしているか
- **認証・認可**: 適切な権限チェックがあるか
- **機密情報**: ハードコードされた認証情報やAPIキーがないか
- **エラーハンドリング**: 適切な例外処理があるか

#### 3-4. パフォーマンスのチェック

- **N+1 クエリ**: `includes` や `preload` を使用しているか
- **不要なクエリ**: 最適化の余地はないか
- **キャッシング**: 適切にキャッシュを活用しているか

#### 3-5. テストカバレッジのチェック

- **テストの有無**: 新機能に対するテストが含まれているか
- **テストの質**: 正常系・異常系をカバーしているか
- **Edge cases**: エッジケースをテストしているか

#### 3-6. ドキュメントのチェック

- **API ドキュメント**: Rswag のドキュメントが更新されているか（Backend API変更の場合）
- **コメント**: 複雑なロジックに適切なコメントがあるか
- **README**: 必要に応じて README が更新されているか

### ステップ4: レビュー結果のまとめ

以下の形式でレビュー結果をまとめてください：

```markdown
# PR #<番号> レビュー: <タイトル>

## 📊 概要
- **Author**: <作成者>
- **Status**: <状態>
- **Changes**: +<追加行数> -<削除行数>
- **Files**: <変更ファイル数>件
- **Labels**: <ラベル>

## 🎯 変更内容のサマリー
[PRの目的と主な変更内容を簡潔に説明]

## ✅ 良い点
[プラスの評価ポイントをリスト形式で]
- 良い点1
- 良い点2

## ⚠️ 改善提案

### 🔴 Critical（必須修正）
[セキュリティやバグなど、マージ前に必ず修正すべき問題]
- [ ] 問題の説明（該当ファイル: `path/to/file.rb:行番号`）

### 🟡 Warning（推奨修正）
[コード品質や保守性に関わる問題]
- [ ] 問題の説明（該当ファイル: `path/to/file.rb:行番号`）

### 🔵 Suggestion（提案）
[より良い実装方法の提案]
- 提案内容

## 📝 プロジェクト規約チェック

### Backend
- [x] ルーティング定義: ✅ / ⚠️ / ❌
- [x] コントローラ配置: ✅ / ⚠️ / ❌
- [x] Schemafile 使用: ✅ / ⚠️ / ❌ / N/A
- [x] Rswag ドキュメント: ✅ / ⚠️ / ❌ / N/A
- [x] RSpec テスト: ✅ / ⚠️ / ❌

### Frontend
- [x] TypeScript 型定義: ✅ / ⚠️ / ❌ / N/A
- [x] React Native Web: ✅ / ⚠️ / ❌ / N/A
- [x] Tailwind CSS: ✅ / ⚠️ / ❌ / N/A

## 🧪 テストカバレッジ
- **テストファイル**: <テストファイル名>
- **カバレッジ**: ✅ 十分 / ⚠️ 不足 / ❌ なし
- **不足している項目**:
  - 項目1
  - 項目2

## 🚀 総合評価
- **マージ可否**: ✅ OK / ⚠️ 条件付きOK / ❌ 要修正
- **理由**: [判断理由を簡潔に]

## 💡 次のステップ
[修正が必要な場合の推奨アクション]
1. ステップ1
2. ステップ2
```

### ステップ5: メモリへの保存

`mcp__serena__write_memory` ツールを使用して保存：
- **memory_name**: `pr-review-<PR番号>`（例: `pr-review-42`）
- **content**: ステップ4で作成したレビュー結果

### ステップ6: ユーザーへの報告

以下を報告：
- レビュー結果のサマリー（ステップ4の内容）
- Critical な問題がある場合は強調して表示
- メモリに保存したことの確認

## レビューのベストプラクティス

### 建設的なフィードバック
- ❌ 「このコードは悪い」
- ✅ 「`find_each` を使うと、大量データでもメモリ効率が良くなります」

### 具体的な提案
- コード例を含める
- 該当箇所（ファイル名と行番号）を明記する
- なぜ改善が必要かを説明する

### ポジティブな指摘
- 良いコードや改善点も積極的に評価する
- チーム全体の学びにつながる工夫を共有する

## 注意事項

- PR番号が指定されていない場合は、ユーザーに PR 番号の入力を促す
- `gh` コマンドが利用できない場合は、GitHub CLI のインストール方法を案内
- 変更内容が膨大な場合は、主要な変更に絞ってレビューすることを提案
- 自動検出できない問題（ビジネスロジックの妥当性など）は、ユーザーに確認を促す
- レビューはあくまで提案であり、最終判断はチーム/レビュアーに委ねることを明記

## 補足: レビュー観点の優先順位

1. **セキュリティ**: 脆弱性、認証・認可の問題
2. **バグ**: ロジックエラー、エッジケース
3. **規約遵守**: プロジェクトのアーキテクチャ、コーディング規約
4. **テスト**: テストの有無と品質
5. **パフォーマンス**: N+1クエリ、不要な処理
6. **可読性**: コードの理解しやすさ
7. **保守性**: 将来の変更のしやすさ
